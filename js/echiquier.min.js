function buildPieces(){"mobile"!=view?(Bwvft=$.extend(!0,{},loadWavefrontFromHTLM("#bishop","bishop")),Rwvft=$.extend(!0,{},loadWavefrontFromHTLM("#rook","rook")),Nwvft=$.extend(!0,{},loadWavefrontFromHTLM("#knight","knight")),Pwvft=$.extend(!0,{},loadWavefrontFromHTLM("#pawn","pawn")),Qwvft=$.extend(!0,{},loadWavefrontFromHTLM("#queen","queen")),Kwvft=$.extend(!0,{},loadWavefrontFromHTLM("#king","king"))):(Bwvft=$.extend(!0,{},loadWavefrontFromHTLM("#flatBishop","bishop")),Rwvft=$.extend(!0,{},loadWavefrontFromHTLM("#flatRook","rook")),Nwvft=$.extend(!0,{},loadWavefrontFromHTLM("#flatKnight","knight")),Pwvft=$.extend(!0,{},loadWavefrontFromHTLM("#flatPawn","pawn")),Qwvft=$.extend(!0,{},loadWavefrontFromHTLM("#flatQueen","queen")),Kwvft=$.extend(!0,{},loadWavefrontFromHTLM("#flatKing","king"))),Pieces.splice(0,Pieces.length);for(var e={},o=0;8>o;o++)for(var t=0;8>t;t++){var s=XYToSquare(t,o);null!=chess.get(s)&&("p"==chess.get(s).type&&(e=$.extend(!0,{},Pwvft)),"n"==chess.get(s).type&&(e=$.extend(!0,{},Nwvft)),"b"==chess.get(s).type&&(e=$.extend(!0,{},Bwvft)),"r"==chess.get(s).type&&(e=$.extend(!0,{},Rwvft)),"q"==chess.get(s).type&&(e=$.extend(!0,{},Qwvft)),"k"==chess.get(s).type&&(e=$.extend(!0,{},Kwvft)),altPiece={id:Pieces.length,square:s,x:t,y:o,flags:"",index:0,color:chess.get(s).color,type:chess.get(s).type,w:{}},setWavefrontId(e,Pieces.length),"w"==chess.get(s).color&&switchMaterialWavefront(e,"blancs"),"b"==chess.get(s).color&&switchMaterialWavefront(e,"noirs"),"mobile"==view?"p"==chess.get(s).type=="pawn"?translateWavefront(e,0,-13,20):translateWavefront(e,0,-13,23):"w"==chess.get(s).color&&rotateWavefront(e,0,180,0),translateWavefront(e,64*-o+224,0,64*-t+224),altPiece.w=$.extend(!0,{},e),Pieces.push(altPiece))}}function getTargetFromMove(e){for(e.includes("+")|e.includes("#")&&(e=e.slice(0,e.length-1)),e.includes("=R")|e.includes("=Q")|e.includes("=R")|e.includes("=B")|e.includes("=N")&&(e=e.slice(0,e.length-2)),"O-O-O"==e&&("w"==chess.turn()?e="c1":"b"==chess.turn()&&(e="c8")),"O-O"==e&&("w"==chess.turn()?e="g1":"b"==chess.turn()&&(e="g8"));e.length>2;)e=e.slice(1,e.length);return e}function XYToSquare(e,o){var t,s;7==o&&(t="a"),6==o&&(t="b"),5==o&&(t="c"),4==o&&(t="d"),3==o&&(t="e"),2==o&&(t="f"),1==o&&(t="g"),0==o&&(t="h"),0==e&&(s="1"),1==e&&(s="2"),2==e&&(s="3"),3==e&&(s="4"),4==e&&(s="5"),5==e&&(s="6"),6==e&&(s="7"),7==e&&(s="8");var a=t+s;return a}function SquareToXY(e){var o,t,s=e.slice(0,1),a=e.slice(1,2);return"a"==s&&(t=7),"b"==s&&(t=6),"c"==s&&(t=5),"d"==s&&(t=4),"e"==s&&(t=3),"f"==s&&(t=2),"g"==s&&(t=1),"h"==s&&(t=0),"1"==a&&(o=0),"2"==a&&(o=1),"3"==a&&(o=2),"4"==a&&(o=3),"5"==a&&(o=4),"6"==a&&(o=5),"7"==a&&(o=6),"8"==a&&(o=7),{x:o,y:t}}function isPromotionMove(e){return e.includes("=R")|e.includes("=Q")|e.includes("=R")|e.includes("=B")|e.includes("=N")?!0:!1}function showWay(e){var o=chess.moves({square:Pieces[e].square});way.splice(0,way.length);for(var t=0;t<o.length;t++){addToWayables(SquareToXY(getTargetFromMove(o[t])).x,SquareToXY(getTargetFromMove(o[t])).y,0);var s={square:getTargetFromMove(o[t]),move:o[t]};if(null!=chess.get(s.square))for(var a=0;a<Pieces.length;a++)Pieces[a].square==s.square&&switchMaterialWavefront(Pieces[a].w,"way way"+t);way.push(s)}}function clearWayables(){boardwvft=loadWavefrontFromHTLM("#board"),boardbuffer=$.extend(!0,{},boardwvft);for(var e=0;e<Pieces.length;e++)"w"==Pieces[e].color&&switchMaterialWavefront(Pieces[e].w,"blancs"),"b"==Pieces[e].color&&switchMaterialWavefront(Pieces[e].w,"noirs");way.splice(0,way.length)}function addToWayables(e,o,t){var s=224,a=224,i=32,n=64,c=0,l=boardwvft.vertices.length,r=[-o*n-i+s,c,-e*n-i+a];boardwvft.vertices.push(r);var d=[-o*n-i+s,c,-e*n+i+a];boardwvft.vertices.push(d);var g=[-o*n+i+s,c,-e*n+i+a];boardwvft.vertices.push(g);var v=[-o*n+i+s,c,-e*n-i+a];boardwvft.vertices.push(v);var u=[l+2,l+4,l+1];boardwvft.triangles.push(u),u=[l+4,l+2,l+3],boardwvft.triangles.push(u),boardwvft.nt=boardwvft.nt+2,boardwvft.nv=boardwvft.nv+4;var w=[0,1,0];boardwvft.triangles[boardwvft.nt-1].mat="way"+way.length,boardwvft.triangles[boardwvft.nt-1].n=w,boardwvft.triangles[boardwvft.nt-2].mat="way"+way.length,boardwvft.triangles[boardwvft.nt-2].n=w,boardbuffer=$.extend(!0,{},boardwvft)}function showUi(){$("#ui").css("display","block"),$("#navhelper").css("display","none")}function closeUi(){$("#ui").css("display","none"),$("#navhelper").css("display","block")}function showPromotionUI(){$("#PromotionUI").css("display","block"),$("#navhelper").css("display","none")}function closePromotionUI(){$("#PromotionUI").css("display","none"),$("#navhelper").css("display","block")}function disposeapplicationlayers(e){var o=$(window).width(),t=$(window).height();"auto"==e&&(view=900>o&&900>t?"mobile":"desktop");var s=100,a=o/t;$("#UI").css({top:0}),$("#UI").css({left:0}),$("#UI").css({width:o}),$("#UI").css({height:t}),$("#PromotionUI").css({top:0}),$("#PromotionUI").css({left:0}),$("#PromotionUI").css({width:o}),$("#PromotionUI").css({height:t}),o>t&&(portrait=!1,paysage=!0),t>o&&(portrait=!0,paysage=!1),1==portrait&&($("#svg8").attr("width",o),$("#svg8").attr("height",t),$("#svg8").attr("viewBox","-"+s/2+" -"+s/2/a+" "+s+" "+s/a)),1==paysage&&($("#svg8").attr("width",o),$("#svg8").attr("height",t),$("#svg8").attr("viewBox","-"+s*a/2+" -"+s/2+" "+s*a+" "+s)),"mobile"==view?(buildPieces(),initViewZlock(270,0,0,770)):(buildPieces(),initViewZlock(220,90,0,690))}function checkGameState(){chess.insufficient_material()&&($("#matchResult").text("MatchPartie nulle, materiel insuffisant"),$("#gameHistory").text(chess.pgn({max_width:15,newline_char:"<br />"}))),chess.in_check()&&("w"==chess.turn()&&($("#matchResult").text("Les blancs sont en Echec"),switchMaterialInWavefrontById(buffer,"wk","incheck")),"b"==chess.turn()&&($("#matchResult").text("Les noirs sont en Echec"),$("#gameHistory").html(""))),chess.in_threefold_repetition()&&($("#matchResult").text("Partie nulle, répétition"),$("#gameHistory").html(chess.pgn({max_width:15,newline_char:"<br />"}))),chess.in_checkmate()&&("w"==chess.turn()&&$("#matchResult").text("Les blancs sont en Echec et mat"),"b"==chess.turn()&&$("#matchResult").text("Les noirs sont en Echec et mat"),$("#gameHistory").html(chess.pgn({max_width:5,newline_char:"<br />"}))),chess.in_check()&&("w"==chess.turn()&&switchMaterialInWavefrontById(buffer,"wk","incheck"),"b"==chess.turn()&&switchMaterialInWavefrontById(buffer,"bk","incheck"),viewChessBoard(),audiocheck.play()),chess.game_over()&&($("#endGameLayer").css("display","block"),$("#navhelper").css("display","none"),viewChessBoard())}function closeEndGameLayer(){$("#endGameLayer").css("display","none"),$("#navhelper").css("display","block")}var Pwvft={},Rwvft={},Nwvft={},Bwvft={},Qwvft={},Kwvft={},TMPwvft={},way=[],promotion={from:"a1",to:"a3",promo:"n"},selectedPiece="none",hand="w",chess=new Chess,view="auto",Pieces=[],audiostart=new Audio("chesssound/start1.ogg"),audiomove=new Audio("chesssound/move1.ogg"),audiocapture=new Audio("chesssound/capture1.ogg"),audiocheck=new Audio("chesssound/check1.ogg"),audiocastle=new Audio("chesssound/castle.ogg"),audioenpassant=new Audio("chesssound/mov2.ogg"),audiowin=new Audio("chesssound/win1.ogg"),audiodraw=new Audio("chesssound/draw1.ogg");$(window).on("load",function(){document.getElementById("banquise").disabled=!0,document.getElementById("cappuccino").disabled=!1,document.getElementById("bois").disabled=!0,void 0!=Cookies.get("fen")&&chess.load(Cookies.get("fen")),void 0==Cookies.get("vue")?(view="auto",Cookies.set("vue","auto"),Log("setting cookie vue")):("auto"==Cookies.get("vue")&&(view="auto"),"mobile"==Cookies.get("vue")&&(view="mobile"),"desktop"==Cookies.get("vue")&&(view="desktop")),Log("#=# cookie : "+Cookies.get("vue")),boardwvft=$.extend(!0,{},loadWavefrontFromHTLM("#board","board")),boardbuffer=$.extend(!0,{},boardwvft),buffer=$.extend(!0,{},boardwvft),disposeapplicationlayers(view),viewChessBoard();var e=document.getElementById("svg8"),o=new Hammer(e);o.get("pan").set({direction:Hammer.DIRECTION_ALL}),o.on("doubletap",function(e){}),o.on("singletap",function(e){}),$(window).on("resize",function(){clearWayables(),disposeapplicationlayers(Cookies.get("vue"))}),$("body").on("click","#uiLayerFooter",function(){closeUi()}),$("body").on("click","#endGameLayerFooter",function(){closeEndGameLayer()}),$("body").on("click","#show-ui",function(){showUi()}),$("body").on("click","#turnLeft",function(){"mobile"!=view&&(rotateViewZlock(0,90,0),viewChessBoard())}),$("body").on("click","#turnRight",function(){"mobile"!=view&&(rotateViewZlock(0,-90,0),viewChessBoard())}),$("body").on("click","*",function(){$(".banner").css("display","none")}),$("body").on("click","#toggleViewMobile",function(){clearWayables(),$("#toggleViewMobile").removeClass("selectedToggle"),$("#toggleViewDesktop").removeClass("selectedToggle"),$("#toggleViewMobile").addClass("selectedToggle"),view="mobile",Cookies.set("vue","mobile"),disposeapplicationlayers("mobile")}),$("body").on("click","#toggleViewDesktop",function(){clearWayables(),$("#toggleViewMobile").removeClass("selectedToggle"),$("#toggleViewDesktop").removeClass("selectedToggle"),$("#toggleViewDesktop").addClass("selectedToggle"),view="desktop",Cookies.set("vue","desktop"),disposeapplicationlayers("desktop")}),$("body").on("click","#toggleViewAuto",function(){clearWayables(),$("#toggleViewMobile").removeClass("selectedToggle"),$("#toggleViewDesktop").removeClass("selectedToggle"),$("#toggleViewAuto").addClass("selectedToggle"),view="auto",Cookies.set("vue","auto"),disposeapplicationlayers("auto")}),$("body").on("click","#resetBoard",function(){chess.reset(),clearWayables(),disposeapplicationlayers("desktop"),viewChessBoard()}),$("#toggleViewMobile").removeClass("selectedToggle"),$("#toggleViewDesktop").removeClass("selectedToggle");var t=Cookies.get("vue");"auto"==t&&$("#toggleViewAuto").addClass("selectedToggle"),"mobile"==t&&$("#toggleViewMobile").addClass("selectedToggle"),"desktop"==t&&$("#toggleViewDesktop").addClass("selectedToggle"),$("body").on("click","#toggleThemeCapucino",function(){$("svg").attr("shape-rendering","geometricPrecision"),document.getElementById("banquise").disabled=!0,document.getElementById("cappuccino").disabled=!1,document.getElementById("bois").disabled=!0,$("#toggleThemeBois").removeClass("selectedToggle"),$("#toggleThemeBanquise").removeClass("selectedToggle"),$("#toggleThemeCapucino").addClass("selectedToggle"),viewChessBoard()}),$("body").on("click","#toggleThemeBanquise",function(){$("svg").attr("shape-rendering","geometricPrecision"),document.getElementById("banquise").disabled=!1,document.getElementById("cappuccino").disabled=!0,document.getElementById("bois").disabled=!0,$("#toggleThemeBois").removeClass("selectedToggle"),$("#toggleThemeBanquise").addClass("selectedToggle"),$("#toggleThemeCapucino").removeClass("selectedToggle"),viewChessBoard()}),$("body").on("click","#toggleRenderingLow",function(){$("svg").attr("shape-rendering","optimisedSpeed"),$("#toggleRenderingHight").removeClass("selectedToggle"),$("#toggleRenderingMiddle").removeClass("selectedToggle"),$("#toggleRenderingLow").addClass("selectedToggle"),viewChessBoard()}),$("body").on("click","#toggleRenderingMiddle",function(){$("svg").attr("shape-rendering","crispEdges"),$("#toggleRenderingLow").removeClass("selectedToggle"),$("#toggleRenderingHight").removeClass("selectedToggle"),$("#toggleRenderingMiddle").addClass("selectedToggle"),viewChessBoard()}),$("body").on("click","#toggleRenderingHight",function(){$("svg").attr("shape-rendering","geometricPrecision"),$("#toggleRenderingLow").removeClass("selectedToggle"),$("#toggleRenderingMiddle").removeClass("selectedToggle"),$("#toggleRenderingHight").addClass("selectedToggle"),viewChessBoard()}),$("body").on("click","#toggleThemeBois",function(){document.getElementById("banquise").disabled=!0,document.getElementById("cappuccino").disabled=!0,document.getElementById("bois").disabled=!1,$("#toggleThemeBois").addClass("selectedToggle"),$("#toggleThemeBanquise").removeClass("selectedToggle"),$("#toggleThemeCapucino").removeClass("selectedToggle"),viewChessBoard()}),o.on("pan",function(e){"mobile"!=view&&(rotateViewZlock(15*e.velocityY,15*e.velocityX,0),viewChessBoard())}),$("body").on("click","#QueenPromotion",function(){chess.move({from:promotmp2.f,to:promotmp2.t,promotion:"q"});buildPieces(),selectedPiece="none",clearWayables(),viewChessBoard(),checkGameState(),closePromotionUI()}),$("body").on("click","#RookPromotion",function(){chess.move({from:promotmp2.f,to:promotmp2.t,promotion:"r"});buildPieces(),selectedPiece="none",clearWayables(),viewChessBoard(),checkGameState(),closePromotionUI()}),$("body").on("click","#KnightPromotion",function(){chess.move({from:promotmp2.f,to:promotmp2.t,promotion:"n"});buildPieces(),selectedPiece="none",clearWayables(),viewChessBoard(),checkGameState(),closePromotionUI()}),$("body").on("click","#BishopPromotion",function(){chess.move({from:promotmp2.f,to:promotmp2.t,promotion:"b"});buildPieces(),selectedPiece="none",clearWayables(),viewChessBoard(),checkGameState(),closePromotionUI()}),$("body").on("click",".piece",function(){var e=getFaceId(this);chess.turn()==Pieces[e].color&&(clearWayables(),switchMaterialWavefront(Pieces[e].w,"selectedPiece"),"none"!=selectedPiece&&("w"==Pieces[selectedPiece].color&&switchMaterialWavefront(Pieces[selectedPiece].w,"blancs"),"b"==Pieces[selectedPiece].color&&switchMaterialWavefront(Pieces[selectedPiece].w,"noirs")),switchMaterialWavefront(Pieces[e].w,"selectedPiece"),selectedPiece=e,showWay(selectedPiece),viewChessBoard())}),$("body").on("click",".way",function(){var e=(getFaceId(this),$(this).attr("class")),o=e.match(/way\d+/)+"";if(selectedway=parseInt(o.match(/\d+/)),isPromotionMove(way[selectedway].move))promotmp=selectedPiece,promotmp2={f:Pieces[selectedPiece].square,t:way[selectedway].square},"w"==chess.turn()&&$(".pce").addClass("blancs"),"b"==chess.turn()&&$(".pce").addClass("noirs"),showPromotionUI();else{var t=chess.move(way[selectedway].move);"n"==t.flags&&audiomove.play(),"b"==t.flags&&audiomove.play(),"e"==t.flags&&audiocapture.play(),"c"==t.flags&&audiocapture.play(),"cp"==t.flags&&audioenpassant.play(),"q"==t.flags|"k"==t.flags&&audiocastle.play(),buildPieces(),selectedPiece="none",clearWayables(),viewChessBoard(),checkGameState(),Cookies.set("fen",chess.fen())}}),$("#svg8").on("mousewheel",function(e){"mobile"!=view&&(translateView(0,0,e.deltaY*e.deltaFactor),viewChessBoard())})});
